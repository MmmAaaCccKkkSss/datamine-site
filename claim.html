<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>DATAMINE — Claim Airdrop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; margin: 0; padding: 24px; background:#0b0b12; color:#e9ecf5;}
    .card { max-width: 760px; margin: 0 auto; border: 1px solid #1f1f36; border-radius: 14px; padding: 24px; background:#141423; box-shadow:0 6px 28px rgba(0,0,0,.35);}
    h1 { margin-top: 0; }
    label { display:block; font-size:14px; margin: 12px 0 6px; color:#cdd3ea;}
    input[type="text"] { width:100%; padding:10px 12px; border:1px solid #2b2b4a; border-radius:10px; font-size:14px; background:#0f1020; color:#dfe3f7;}
    button { padding:12px 16px; border:0; border-radius:10px; cursor:pointer; font-weight:600; }
    .primary { background:#6b5bff; color:#fff; }
    .ghost { background:#1a1a33; color:#dfe3f7; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .muted { color:#9aa0b3; font-size:13px; }
    .ok { color:#1BC7B1; }
    .warn { color:#ffb74d; }
    .err { color:#ff6b6b; }
    .mono { font-family: ui-monospace, SFMono, Menlo, Consolas, monospace; }
    .hr { height:1px; background:#1f1f36; margin: 16px 0; }
    .small { font-size:12px; color:#9aa0b3;}
    .diag { margin-top:10px; font-size:12px; color:#9aa0b3 }
  </style>
</head>
<body>
  <div class="card">
    <h1>DATAMINE — Claim Airdrop</h1>
    <p class="muted">Réclame tes <b>DATA</b> en connectant ton wallet Polygon (chain 137). Cette page appelle uniquement <code>claim(uint256, bytes32[])</code> du contrat MerkleDistributor.</p>

    <div class="diag" id="diag">Diagnostic: en attente…</div>

    <label>Adresse du MerkleDistributor</label>
    <input id="distributor" type="text" value="0xMERKLE_DISTRIBUTOR_ADDRESS_ICI" />

    <label>URL de <code>claims.json</code></label>
    <input id="claimsUrl" type="text" value="./claims.json" />

    <div class="row" style="margin-top:16px">
      <button id="connectBtn" class="primary">1) Connecter mon wallet</button>
      <span id="addr" class="mono muted"></span>
    </div>

    <div id="networkBox" class="muted" style="margin-top:10px"></div>
    <div class="hr"></div>

    <div class="row">
      <button id="loadBtn" class="ghost">2) Charger mon allocation</button>
      <span id="alloc" class="muted"></span>
    </div>
    <div id="eligBox" style="margin-top:10px"></div>

    <div class="hr"></div>

    <div class="row">
      <button id="claimBtn" class="primary">3) Claim mes DATA</button>
      <span id="status" class="muted"></span>
    </div>

    <p class="small" style="margin-top:14px">
      Place <code>claims.json</code> à la racine du site (même dossier que cette page) ou mets une URL complète.
    </p>
  </div>

  <!-- Ethers.js v5 — double CDN pour fiabilité -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" crossorigin="anonymous"></script>
  <script>if(typeof ethers==="undefined"){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>')}</script>

  <script>
    const POLYGON_CHAIN_ID = '0x89'; // 137
    const POLYGON_PARAMS = {
      chainId: POLYGON_CHAIN_ID,
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name:'POL', symbol:'POL', decimals:18 },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };
    const MERKLE_ABI = [
      "function claimed(address) view returns (bool)",
      "function claim(uint256 amount, bytes32[] calldata proof) external"
    ];

    const diag = document.getElementById('diag');
    function setDiag(msg){ diag.textContent = 'Diagnostic: ' + msg; }

    let provider, signer, account, claimsMap = null;
    const connectBtn = document.getElementById('connectBtn');
    const addrEl = document.getElementById('addr');
    const networkBox = document.getElementById('networkBox');
    const loadBtn = document.getElementById('loadBtn');
    const allocEl = document.getElementById('alloc');
    const eligBox = document.getElementById('eligBox');
    const claimBtn = document.getElementById('claimBtn');
    const statusEl = document.getElementById('status');

    // Diagnostic au chargement
    (function initDiag(){
      const hasMM = typeof window.ethereum !== 'undefined';
      const hasEthers = typeof window.ethers !== 'undefined';
      setDiag((hasMM?'MetaMask détecté ✅':'MetaMask non détecté ❌') + ' | ' + (hasEthers?'ethers.js chargé ✅':'ethers.js non chargé ❌'));
    })();

    connectBtn.onclick = connect;
    loadBtn.onclick = loadAllocation;
    claimBtn.onclick = doClaim;

    async function connect() {
      try {
        if (!window.ethereum) { alert('MetaMask non détecté. Installe l’extension et recharge la page.'); return; }
        await ethereum.request({ method: 'eth_requestAccounts' });
        if (!window.ethers) { alert('Problème de chargement d’ethers.js. Recharge la page (Ctrl+F5).'); return; }

        provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
        const network = await provider.getNetwork();

        if (network.chainId !== 137) {
          networkBox.innerHTML = 'Réseau: <b>'+network.name+'</b>. <span class="warn">Passe sur Polygon.</span> ';
          const switchBtn = document.createElement('button');
          switchBtn.textContent = 'Basculer sur Polygon';
          switchBtn.className = 'ghost';
          switchBtn.onclick = switchToPolygon;
          networkBox.appendChild(switchBtn);
        } else {
          networkBox.innerHTML = '<span class="ok">Réseau Polygon détecté ✅</span>';
        }

        signer  = provider.getSigner();
        account = await signer.getAddress();
        addrEl.textContent = account;
        setDiag('Connexion ok. Réseau chainId='+network.chainId);
      } catch(e){
        console.error(e);
        alert('Connexion refusée ou erreur: '+(e?.message||e));
        setDiag('Erreur connexion: '+(e?.message||e));
      }
    }

    async function switchToPolygon() {
      try {
        await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_ID }] });
        networkBox.innerHTML = '<span class="ok">Réseau Polygon détecté ✅</span>';
        setDiag('Basculé sur Polygon.');
      } catch (e) {
        if (e.code === 4902) {
          await ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PARAMS] });
          networkBox.innerHTML = '<span class="ok">Réseau Polygon ajouté ✅</span>';
          setDiag('Réseau ajouté.');
        } else {
          alert('Switch annulé : '+e.message);
          setDiag('Switch annulé: '+e.message);
        }
      }
    }

    async function loadAllocation() {
      try {
        statusEl.textContent = ''; eligBox.textContent = ''; allocEl.textContent = 'Chargement…';
        const distributorAddr = (document.getElementById('distributor').value||'').trim();
        const claimsUrl = (document.getElementById('claimsUrl').value||'').trim();
        if (!distributorAddr || !claimsUrl) { allocEl.textContent=''; alert('Renseigne MerkleDistributor et l’URL de claims.json'); return; }

        const res = await fetch(claimsUrl, { cache:'no-store' });
        if (!res.ok) throw new Error('Impossible de charger claims.json');
        claimsMap = await res.json();

        if (!account) { allocEl.textContent=''; alert('Connecte ton wallet d’abord.'); return; }
        const key = account.toLowerCase();
        if (!claimsMap[key]) { allocEl.textContent=''; eligBox.innerHTML='<span class="err">Adresse non éligible.</span>'; return; }

        const { amount, proof } = claimsMap[key];
        const amountHuman = ethers.utils.formatUnits(amount, 18);
        allocEl.innerHTML = `Éligible: <b>${amountHuman} DATA</b>`;

        const c = new ethers.Contract(distributorAddr, MERKLE_ABI, provider);
        const already = await c.claimed(account);
        eligBox.innerHTML = already ? '<span class="warn">Déjà réclamé ✅</span>' : '<span class="ok">Non réclamé — prêt à claim</span>';
      } catch(e){ allocEl.textContent=''; eligBox.innerHTML='<span class="err">Erreur: '+(e?.message||e)+'</span>'; setDiag('Erreur load: '+(e?.message||e)); }
    }

    async function doClaim() {
      try {
        statusEl.textContent = 'Préparation…';
        const distributorAddr = (document.getElementById('distributor').value||'').trim();
        const claimsUrl = (document.getElementById('claimsUrl').value||'').trim();
        if (!account || !signer) { alert('Connecte ton wallet.'); statusEl.textContent=''; return; }
        if (!claimsMap) { await loadAllocation(); if (!claimsMap) return; }
        const entry = claimsMap[account.toLowerCase()];
        if (!entry) { statusEl.innerHTML = '<span class="err">Adresse non éligible.</span>'; return; }

        const { amount, proof } = entry;
        const contract = new ethers.Contract(distributorAddr, MERKLE_ABI, signer);
        const tx = await contract.claim(amount, proof);
        statusEl.textContent = 'Tx envoyée: '+tx.hash+' (en attente…)';
        const rec = await tx.wait();
        statusEl.innerHTML = rec.status===1 ? '<span class="ok">Claim réussi ✅</span>' : '<span class="err">Échec de la transaction.</span>';
        if (rec.status===1) await loadAllocation();
      } catch(e){ statusEl.innerHTML = '<span class="err">Erreur: '+(e?.message||e)+'</span>'; setDiag('Erreur claim: '+(e?.message||e)); }
    }
  </script>
</body>
</html>
